<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>اخبار صحن ولیعصر</title>
<link rel="icon" type="image/png" href="logo.png">
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
* { box-sizing: border-box; }

body {
  background: #000000;
  color: #e5e7eb;
  font-family: 'Vazirmatn', sans-serif;
  margin: 0;
  padding: 0;
}

.header {
  background: #111111;
  padding: 15px 20px;
  border-bottom: 3px solid #ef4444;
  position: sticky;
  top: 0;
  z-index: 100;
}

.header-content {
  max-width: 1400px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
}

.title-wrapper { 
  display: flex; 
  gap: 15px;
  justify-content: center;
  align-items: center;
}

.title-word-1 { color: #239f40; font-size: 2.5rem; font-weight: 900; margin: 0; }
.title-word-2 { color: #ffffff; font-size: 2.5rem; font-weight: 900; margin: 0; }
.title-word-3 { color: #da0000; font-size: 2.5rem; font-weight: 900; margin: 0; }

.container {
  display: flex;
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
  gap: 20px;
}

.nav-menu {
  width: 200px;
  flex-shrink: 0;
  position: sticky;
  top: 120px;
  height: fit-content;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.nav-item {
  background: #111111;
  padding: 15px 20px;
  margin-bottom: 10px;
  border: 2px solid #222;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  width: 100%;
  text-align: center;
}

.nav-item:hover { background: #1a1a1a; border-color: #ef4444; }
.nav-item.active { background: #1a1a1a; border-color: #ef4444; }
.nav-item i { color: #ef4444; }

.pinned-section {
  width: 350px;
  flex-shrink: 0;
  position: sticky;
  top: 120px;
  height: fit-content;
  max-height: calc(100vh - 140px);
  overflow-y: auto;
}

.pinned-title {
  background: #111111;
  padding: 15px;
  border: 2px solid #ef4444;
  margin-bottom: 15px;
  text-align: center;
  font-size: 1.3rem;
  font-weight: bold;
  color: #ef4444;
}

.pinned-news {
  background: #111111;
  border: 2px solid #333;
  overflow: hidden;
  margin-bottom: 15px;
  cursor: pointer;
  transition: all 0.3s;
}

.pinned-news:hover { border-color: #ef4444; }

.pinned-news video,
.pinned-news img {
  width: 100%;
  height: auto;
  max-height: 300px;
  object-fit: contain;
  display: block;
  background: #000;
}

.pinned-news .content { padding: 15px; }
.pinned-news h3 { margin: 0 0 10px 0; color: #ffffff; font-size: 1.1rem; }
.pinned-news p { margin: 0; color: #cbd5e1; line-height: 1.6; font-size: 0.9rem; }

.main-news { flex: 1; display: flex; flex-direction: column; gap: 20px; }

.article {
  background: #111111;
  border: 2px solid #222;
  cursor: pointer;
  transition: all 0.3s;
  overflow: hidden;
}

.article:hover { border-color: #ef4444; transform: translateY(-2px); }
.article.hidden { display: none; }

.article img,
.article video {
  width: 100%;
  height: auto;
  max-height: 600px;
  object-fit: contain;
  display: block;
  background: #000;
}

.article .content { padding: 20px; }
.article h2 { margin: 0 0 15px 0; color: #ffffff; font-size: 1.5rem; }
.article .text { color: #cbd5e1; line-height: 1.8; font-size: 1rem; }

.sidebar {
  width: 250px;
  flex-shrink: 0;
  position: sticky;
  top: 120px;
  height: fit-content;
}

.search-box {
  background: #111111;
  padding: 15px;
  margin-bottom: 15px;
  border: 2px solid #222;
}

.search-box h3 { margin: 0 0 15px 0; color: #ffffff; font-size: 1.1rem; text-align: center; }

.search-input {
  width: 100%;
  padding: 10px;
  border: 2px solid #333;
  background: #000;
  color: #e5e7eb;
  font-family: 'Vazirmatn', sans-serif;
  font-size: 0.95rem;
}

.search-input:focus { outline: none; border-color: #ffffff; }

.eitaa-box {
  background: #111111;
  padding: 15px;
  border: 2px solid #222;
  text-align: center;
}

.eitaa-box h3 { margin: 0 0 15px 0; color: #ffffff; font-size: 1.1rem; }

.eitaa-link {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  width: 100%;
  padding: 12px;
  background: #ef4444;
  color: #000;
  text-decoration: none;
  font-weight: bold;
  font-size: 1rem;
  transition: all 0.3s;
}

.eitaa-link:hover { background: #dc2626; }
.eitaa-link i { font-size: 1.3rem; }

/* Loading Spinner */
.loading-spinner {
  text-align: center;
  padding: 40px;
  color: #ffffff;
  font-size: 1.2rem;
}

.loading-spinner i {
  animation: spin 1s linear infinite;
  font-size: 2rem;
  color: #ef4444;
}

@keyframes spin {
  100% { transform: rotate(360deg); }
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.98);
  z-index: 1000;
  overflow-y: auto;
}

.modal.active { display: block; }

.modal-content {
  max-width: 1000px;
  margin: 0 auto;
  padding: 60px 20px 40px;
}

.modal-close {
  position: fixed;
  top: 20px;
  left: 20px;
  background: #ef4444;
  color: #000;
  border: none;
  width: 50px;
  height: 50px;
  font-size: 1.5rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
  z-index: 1001;
}

.modal-close:hover { background: #dc2626; transform: rotate(90deg); }

.modal-article {
  background: #111111;
  border: 3px solid #ef4444;
  padding: 30px;
}

.modal-article img,
.modal-article video {
  width: 100%;
  height: auto;
  max-height: 700px;
  object-fit: contain;
  display: block;
  margin-bottom: 30px;
  background: #000;
}

.modal-article h1 {
  color: #ffffff;
  font-size: 2.5rem;
  margin: 0 0 30px 0;
  border-bottom: 2px solid #ef4444;
  padding-bottom: 20px;
}

.modal-article .full-text {
  color: #cbd5e1;
  line-height: 2;
  font-size: 1.2rem;
  white-space: pre-wrap;
}

.error { color: #ef4444; text-align: center; font-size: 1.2rem; padding: 40px; }
.loading { text-align: center; color: #ffffff; font-size: 1.2rem; padding: 40px; }
.no-results { text-align: center; color: #888; padding: 40px; font-size: 1.2rem; }

@media (min-width: 769px) {
  .pinned-section { display: block; }
  .sidebar { display: block; }
}

@media (max-width: 768px) {
  .title-word-1, .title-word-2, .title-word-3 { font-size: 1.8rem; }
  .modal-article h1 { font-size: 1.8rem; }
  .modal-article .full-text { font-size: 1rem; }
  
  .pinned-section {
    display: block;
    width: 100%;
    position: static;
    max-height: none;
    margin-bottom: 20px;
  }
  
  .pinned-wrapper {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    scroll-behavior: smooth;
    padding: 5px;
    -webkit-overflow-scrolling: touch;
  }
  
  .pinned-wrapper::-webkit-scrollbar { height: 4px; }
  .pinned-wrapper::-webkit-scrollbar-track { background: #111; border-radius: 2px; }
  .pinned-wrapper::-webkit-scrollbar-thumb { background: #ef4444; border-radius: 2px; }
  
  .pinned-news {
    flex: 0 0 auto;
    width: 280px;
    min-width: 280px;
    margin-bottom: 0;
    border-radius: 8px;
  }
  
  .pinned-news video, .pinned-news img { max-height: 150px; }
  .pinned-news .content { padding: 10px; }
  .pinned-news h3 { font-size: 0.95rem; margin-bottom: 5px; }
  .pinned-news p {
    font-size: 0.8rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .nav-menu {
    width: 100%;
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: center;
    gap: 10px;
    position: static;
    background: #000;
    padding: 15px 0;
    margin-bottom: 10px;
  }
  
  .nav-item {
    white-space: nowrap;
    margin-bottom: 0;
    padding: 12px 20px;
    font-size: 0.9rem;
    width: auto;
    min-width: 100px;
  }
  
  .sidebar { display: none; }
  .container { flex-direction: column; }
  .main-news { order: 3; }
}
</style>
</head>
<body>

<div class="header">
  <div class="header-content">
    <div class="title-wrapper">
      <h1 class="title-word-1">اخبار</h1>
      <h1 class="title-word-2">صحن</h1>
      <h1 class="title-word-3">ولیعصر</h1>
    </div>
  </div>
</div>

<div class="container">
  <nav class="nav-menu">
    <div class="nav-item active" id="homeBtn"><i class="fas fa-home"></i> صفحه اصلی</div>
    <div class="nav-item" id="videoBtn"><i class="fas fa-video"></i> ویدیوها</div>
    <div class="nav-item" id="imageBtn"><i class="fas fa-images"></i> گالری تصاویر</div>
  </nav>
  
  <aside class="pinned-section">
    <div class="pinned-title">
      <i class="fas fa-thumbtack"></i> اخبار ویژه
    </div>
    <div class="pinned-wrapper" id="pinnedNews">
      <p class="loading">در حال بارگذاری...</p>
    </div>
  </aside>
  
  <main class="main-news">
    <div id="news"><p class="loading">در حال بارگذاری اخبار...</p></div>
    <div id="loadingSpinner" class="loading-spinner" style="display: none;">
      <i class="fas fa-spinner"></i>
      <p>در حال بارگذاری اخبار بیشتر...</p>
    </div>
  </main>
  
  <aside class="sidebar">
    <div class="search-box">
      <h3><i class="fas fa-search"></i> جستجو</h3>
      <input type="text" class="search-input" id="searchInput" placeholder="عنوان خبر را جستجو کنید...">
    </div>
    
    <div class="eitaa-box">
      <h3><i class="fas fa-paper-plane"></i> کانال ایتا</h3>
      <a href="https://eitaa.com/valiasrfoari" class="eitaa-link" target="_blank">
        <i class="fas fa-external-link-alt"></i>
        <span>عضویت در کانال</span>
      </a>
    </div>
  </aside>
</div>

<div id="articleModal" class="modal">
  <button class="modal-close" onclick="closeModal()">
    <i class="fas fa-times"></i>
  </button>
  <div class="modal-content">
    <div id="modalArticleContent" class="modal-article">
      <p class="loading">در حال بارگذاری...</p>
    </div>
  </div>
</div>

<script>
const newsContainer = document.getElementById("news");
const pinnedNewsContainer = document.getElementById("pinnedNews");
const searchInput = document.getElementById("searchInput");
const modal = document.getElementById("articleModal");
const modalContent = document.getElementById("modalArticleContent");
const homeBtn = document.getElementById("homeBtn");
const videoBtn = document.getElementById("videoBtn");
const imageBtn = document.getElementById("imageBtn");
const navItems = document.querySelectorAll('.nav-item');
const loadingSpinner = document.getElementById("loadingSpinner");

let allArticles = [];
let pinnedArticles = [];
let currentPage = 0;
const PAGE_SIZE = 20;
let currentFilter = 'all';
let isLoading = false;
let hasMore = true;

// Intersection Observer for lazy loading images
const imageObserver = new IntersectionObserver((entries, observer) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      const img = entry.target;
      if (img.dataset.src) {
        img.src = img.dataset.src;
        img.removeAttribute('data-src');
        observer.unobserve(img);
      }
    }
  });
}, { rootMargin: '200px' });

// Home button - Reset filter & scroll to top
homeBtn.addEventListener('click', function() {
  currentFilter = 'all';
  navItems.forEach(item => item.classList.remove('active'));
  homeBtn.classList.add('active');
  resetAndLoad();
});

// Video filter button
videoBtn.addEventListener('click', function() {
  currentFilter = 'video';
  navItems.forEach(item => item.classList.remove('active'));
  videoBtn.classList.add('active');
  resetAndLoad();
});

// Image filter button
imageBtn.addEventListener('click', function() {
  currentFilter = 'image';
  navItems.forEach(item => item.classList.remove('active'));
  imageBtn.classList.add('active');
  resetAndLoad();
});

function resetAndLoad() {
  newsContainer.innerHTML = "";
  currentPage = 0;
  hasMore = true;
  isLoading = false;
  loadNextPage();
}

async function fetchText(url) {
  const response = await fetch(url);
  if (!response.ok) throw new Error(`خطا در بارگذاری ${url}`);
  return await response.text();
}

async function loadNews() {
  try {
    const timestamp = new Date().getTime();
    const response = await fetch(`articles/index.json?t=${timestamp}`, {
      cache: 'no-store',
      headers: { 'Cache-Control': 'no-cache' }
    });
    
    if (!response.ok) throw new Error(`خطا: ${response.status}`);
    
    const data = await response.json();
    
    // New format with media types
    if (data.pinned && data.articles) {
      pinnedArticles = data.pinned;
      allArticles = data.articles;
    } else if (Array.isArray(data)) {
      // Old format - assume all are images
      pinnedArticles = data.slice(0, 1);
      allArticles = data;
    } else {
      throw new Error('فرمت JSON نامعتبر');
    }
    
    // Load pinned news
    await loadPinnedNews();
    
    // Load first page of articles
    loadNextPage();
    
    // Setup infinite scroll
    window.addEventListener('scroll', handleScroll);

  } catch (error) {
    console.error(error);
    newsContainer.innerHTML = `<p class='error'>خطا: ${error.message}</p>`;
  }
}

async function loadPinnedNews() {
  pinnedNewsContainer.innerHTML = "";
  
  for (let folder of pinnedArticles) {
    try {
      const articleData = allArticles.find(a => a.folder === folder) || { folder, type: 'img' };
      const fullText = await fetchText(`articles/${folder}/text.txt`);
      const lines = fullText.split('\n');
      const titleText = lines[0].trim();
      const contentText = lines.slice(1).join('\n').trim();
      
      const pinnedContainer = document.createElement('div');
      pinnedContainer.className = 'pinned-news';
      pinnedContainer.onclick = () => openModal(folder, titleText, contentText, articleData.type);
      
      const mediaElement = createMediaElement(folder, articleData.type, false);
      
      const content = document.createElement('div');
      content.className = 'content';
      
      const title = document.createElement('h3');
      title.textContent = titleText;
      
      const text = document.createElement('p');
      text.textContent = contentText.substring(0, 80) + '...';
      
      content.append(title, text);
      pinnedContainer.append(mediaElement, content);
      pinnedNewsContainer.appendChild(pinnedContainer);
    } catch (err) {
      console.error(`خطا در خبر ویژه ${folder}:`, err);
    }
  }
  
  if (pinnedNewsContainer.children.length === 0) {
    pinnedNewsContainer.innerHTML = "<p class='error'>خبر ویژه‌ای وجود ندارد</p>";
  }
}

function createMediaElement(folder, type, lazy = true) {
  if (type === 'video') {
    const video = document.createElement('video');
    video.controls = true;
    if (lazy) {
      video.dataset.src = `articles/${folder}/cover.mp4`;
      video.innerHTML = `<source src="" type="video/mp4">`;
    } else {
      video.src = `articles/${folder}/cover.mp4`;
    }
    return video;
  } else {
    const img = document.createElement('img');
    if (lazy) {
      img.dataset.src = `articles/${folder}/cover.jpg?t=${new Date().getTime()}`;
      img.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1 1"%3E%3C/svg%3E';
      img.loading = 'lazy';
      imageObserver.observe(img);
    } else {
      img.src = `articles/${folder}/cover.jpg?t=${new Date().getTime()}`;
    }
    img.onerror = () => { img.style.display = 'none'; };
    return img;
  }
}

function loadNextPage() {
  if (isLoading || !hasMore) return;
  
  isLoading = true;
  loadingSpinner.style.display = 'block';
  
  const start = currentPage * PAGE_SIZE;
  const end = start + PAGE_SIZE;
  const pageArticles = allArticles.slice(start, end);
  
  if (pageArticles.length === 0) {
    hasMore = false;
    loadingSpinner.style.display = 'none';
    return;
  }
  
  // Create document fragment for better performance
  const fragment = document.createDocumentFragment();
  
  pageArticles.forEach(async (articleData) => {
    try {
      const folder = articleData.folder || articleData;
      const type = articleData.type || 'img';
      const fullText = await fetchText(`articles/${folder}/text.txt`);
      const lines = fullText.split('\n');
      const titleText = lines[0].trim();
      const contentText = lines.slice(1).join('\n').trim();
      
      const container = document.createElement("div");
      container.className = "article";
      if (currentFilter !== 'all') {
        if ((currentFilter === 'video' && type !== 'video') ||
            (currentFilter === 'image' && type !== 'img')) {
          container.classList.add('hidden');
        }
      }
      container.dataset.title = titleText.toLowerCase();
      container.dataset.type = type;
      container.onclick = () => openModal(folder, titleText, contentText, type);
      
      // Create media element with lazy loading
      const mediaElement = createMediaElement(folder, type, true);
      
      const contentDiv = document.createElement("div");
      contentDiv.className = "content";
      
      const title = document.createElement("h2");
      title.textContent = titleText;
      
      const text = document.createElement("div");
      text.className = "text";
      text.textContent = contentText.substring(0, 150) + '...';
      
      contentDiv.append(title, text);
      container.append(mediaElement, contentDiv);
      fragment.appendChild(container);
    } catch (err) {
      console.error(`خطا در مقاله ${folder}:`, err);
    }
  });
  
  // Append all at once
  setTimeout(() => {
    newsContainer.appendChild(fragment);
    currentPage++;
    isLoading = false;
    loadingSpinner.style.display = 'none';
    
    if (currentPage * PAGE_SIZE >= allArticles.length) {
      hasMore = false;
    }
  }, 100);
}

function handleScroll() {
  if (!hasMore || isLoading) return;
  
  const scrollPosition = window.innerHeight + window.scrollY;
  const threshold = document.body.offsetHeight - 200;
  
  if (scrollPosition >= threshold) {
    loadNextPage();
  }
}

function filterByType(type) {
  currentFilter = type;
  let visibleCount = 0;
  
  const articles = document.querySelectorAll('.article');
  articles.forEach(article => {
    const articleType = article.dataset.type;
    if (type === 'all') {
      article.classList.remove('hidden');
      visibleCount++;
    } else if (type === 'video' && articleType === 'video') {
      article.classList.remove('hidden');
      visibleCount++;
    } else if (type === 'image' && articleType === 'img') {
      article.classList.remove('hidden');
      visibleCount++;
    } else {
      article.classList.add('hidden');
    }
  });
  
  const existingNoResults = document.querySelector('.no-results');
  if (existingNoResults) existingNoResults.remove();
  
  if (visibleCount === 0 && type !== 'all') {
    const noResults = document.createElement('p');
    noResults.className = 'no-results';
    noResults.textContent = type === 'video' ? 'هیچ ویدیویی یافت نشد.' : 'هیچ تصویری یافت نشد.';
    newsContainer.appendChild(noResults);
  }
}

async function openModal(folder, title, content, type) {
  modalContent.innerHTML = '<p class="loading">در حال بارگذاری...</p>';
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
  
  try {
    const fullText = await fetchText(`articles/${folder}/text.txt`);
    const lines = fullText.split('\n');
    const fullContent = lines.slice(1).join('\n').trim();
    
    let mediaHTML = '';
    if (type === 'video') {
      mediaHTML = `<video controls src="articles/${folder}/cover.mp4" style="width:100%;max-height:700px;display:block;margin-bottom:30px;background:#000"></video>`;
    } else {
      mediaHTML = `<img src="articles/${folder}/cover.jpg?t=${new Date().getTime()}" alt="${title}" style="width:100%;max-height:700px;display:block;margin-bottom:30px;background:#000">`;
    }
    
    modalContent.innerHTML = `
      ${mediaHTML}
      <h1>${title}</h1>
      <div class="full-text">${fullContent}</div>
    `;
  } catch (err) {
    modalContent.innerHTML = `<p class="error">خطا در بارگذاری خبر: ${err.message}</p>`;
  }
}

function closeModal() {
  modal.classList.remove('active');
  document.body.style.overflow = 'auto';
}

modal.addEventListener('click', (e) => {
  if (e.target === modal) closeModal();
});

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && modal.classList.contains('active')) closeModal();
});

function performSearch() {
  const searchTerm = searchInput.value.toLowerCase().trim();
  
  let visibleCount = 0;
  const articles = document.querySelectorAll('.article');
  
  articles.forEach(article => {
    const title = article.dataset.title || '';
    if (searchTerm === '' || title.includes(searchTerm)) {
      article.classList.remove('hidden');
      visibleCount++;
    } else {
      article.classList.add('hidden');
    }
  });
  
  const existingNoResults = document.querySelector('.no-results');
  if (existingNoResults) existingNoResults.remove();
  
  if (visibleCount === 0 && searchTerm !== '') {
    const noResults = document.createElement('p');
    noResults.className = 'no-results';
    noResults.textContent = 'هیچ خبری با این عنوان یافت نشد.';
    newsContainer.appendChild(noResults);
  }
}

searchInput.addEventListener('input', performSearch);

// Initialize
loadNews();
</script>

</body>
</html>
