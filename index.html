<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>اخبار صحن ولیعصر</title>
<link rel="icon" type="image/png" href="logo.png">
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
* { box-sizing: border-box; }
body {
  background: #000000;
  color: #e5e7eb;
  font-family: 'Vazirmatn', sans-serif;
  margin: 0;
  padding: 0;
}
.header {
  background: #111111;
  padding: 15px 20px;
  border-bottom: 3px solid #ef4444;
  position: sticky;
  top: 0;
  z-index: 100;
}
.header-content {
  max-width: 1400px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
}
.title-wrapper { display: flex; gap: 15px; justify-content: center; align-items: center; }
.title-word-1 { color: #239f40; font-size: 2.5rem; font-weight: 900; margin: 0; }
.title-word-2 { color: #ffffff; font-size: 2.5rem; font-weight: 900; margin: 0; }
.title-word-3 { color: #da0000; font-size: 2.5rem; font-weight: 900; margin: 0; }
.container {
  display: flex;
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
  gap: 20px;
}
.nav-menu {
  width: 200px;
  flex-shrink: 0;
  position: sticky;
  top: 120px;
  height: fit-content;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.nav-item {
  background: #111111;
  padding: 15px 20px;
  margin-bottom: 10px;
  border: 2px solid #222;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  width: 100%;
  text-align: center;
}
.nav-item:hover { background: #1a1a1a; border-color: #ef4444; }
.nav-item.active { background: #1a1a1a; border-color: #ef4444; }
.nav-item i { color: #ef4444; }
.pinned-section {
  width: 350px;
  flex-shrink: 0;
  position: sticky;
  top: 120px;
  height: fit-content;
  max-height: calc(100vh - 140px);
  overflow-y: auto;
}
.pinned-title {
  background: #111111;
  padding: 15px;
  border: 2px solid #ef4444;
  margin-bottom: 15px;
  text-align: center;
  font-size: 1.3rem;
  font-weight: bold;
  color: #ef4444;
}
.pinned-news {
  background: #111111;
  border: 2px solid #333;
  overflow: hidden;
  margin-bottom: 15px;
  cursor: pointer;
  transition: all 0.3s;
}
.pinned-news:hover { border-color: #ef4444; }
.pinned-news img,
.pinned-news video {
  width: 100%;
  height: auto;
  max-height: 300px;
  object-fit: contain;
  display: block;
  background: #000;
}
.pinned-news .content { padding: 15px; }
.pinned-news h3 { margin: 0 0 10px 0; color: #ffffff; font-size: 1.1rem; }
.pinned-news p { margin: 0; color: #cbd5e1; line-height: 1.6; font-size: 0.9rem; }
.main-news { flex: 1; display: flex; flex-direction: column; gap: 20px; }
.article {
  background: #111111;
  border: 2px solid #222;
  cursor: pointer;
  transition: all 0.3s;
  overflow: hidden;
}
.article:hover { border-color: #ef4444; transform: translateY(-2px); }
.article.hidden { display: none; }
.article img,
.article video {
  width: 100%;
  height: auto;
  max-height: 600px;
  object-fit: contain;
  display: block;
  background: #000;
}
.article video {
  max-height: 400px;
}
.article .content { padding: 20px; }
.article h2 { margin: 0 0 15px 0; color: #ffffff; font-size: 1.5rem; }
.article .text { color: #cbd5e1; line-height: 1.8; font-size: 1rem; }
.sidebar {
  width: 250px;
  flex-shrink: 0;
  position: sticky;
  top: 120px;
  height: fit-content;
}
.search-box {
  background: #111111;
  padding: 15px;
  margin-bottom: 15px;
  border: 2px solid #222;
}
.search-box h3 { margin: 0 0 15px 0; color: #ffffff; font-size: 1.1rem; text-align: center; }
.search-input {
  width: 100%;
  padding: 10px;
  border: 2px solid #333;
  background: #000;
  color: #e5e7eb;
  font-family: 'Vazirmatn', sans-serif;
  font-size: 0.95rem;
}
.search-input:focus { outline: none; border-color: #ffffff; }
.eitaa-box {
  background: #111111;
  padding: 15px;
  border: 2px solid #222;
  text-align: center;
}
.eitaa-box h3 { margin: 0 0 15px 0; color: #ffffff; font-size: 1.1rem; }
.eitaa-link {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  width: 100%;
  padding: 12px;
  background: #ef4444;
  color: #000;
  text-decoration: none;
  font-weight: bold;
  font-size: 1rem;
  transition: all 0.3s;
}
.eitaa-link:hover { background: #dc2626; }
.eitaa-link i { font-size: 1.3rem; }
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.98);
  z-index: 1000;
  overflow-y: auto;
}
.modal.active { display: block; }
.modal-content {
  max-width: 1000px;
  margin: 0 auto;
  padding: 60px 20px 40px;
}
.modal-close {
  position: fixed;
  top: 20px;
  left: 20px;
  background: #ef4444;
  color: #000;
  border: none;
  width: 50px;
  height: 50px;
  font-size: 1.5rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
  z-index: 1001;
}
.modal-close:hover { background: #dc2626; transform: rotate(90deg); }
.modal-article {
  background: #111111;
  border: 3px solid #ef4444;
  padding: 30px;
}
.modal-article img,
.modal-article video {
  width: 100%;
  height: auto;
  max-height: 700px;
  object-fit: contain;
  display: block;
  margin-bottom: 30px;
  background: #000;
}
.modal-article h1 {
  color: #ffffff;
  font-size: 2.5rem;
  margin: 0 0 30px 0;
  border-bottom: 2px solid #ef4444;
  padding-bottom: 20px;
}
.modal-article .full-text {
  color: #cbd5e1;
  line-height: 2;
  font-size: 1.2rem;
  white-space: pre-wrap;
}
.error { color: #ef4444; text-align: center; font-size: 1.2rem; padding: 40px; }
.loading { text-align: center; color: #ffffff; font-size: 1.2rem; padding: 40px; }
.no-results { text-align: center; color: #888; padding: 40px; font-size: 1.2rem; }

@media (min-width: 769px) {
  .pinned-section { display: block; }
  .sidebar { display: block; }
}
@media (max-width: 768px) {
  .title-word-1, .title-word-2, .title-word-3 { font-size: 1.8rem; }
  .modal-article h1 { font-size: 1.8rem; }
  .modal-article .full-text { font-size: 1rem; }
  .pinned-section {
    display: block;
    width: 100%;
    position: static;
    max-height: none;
    margin-bottom: 20px;
  }
  .pinned-wrapper {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    scroll-behavior: smooth;
    padding: 5px;
    -webkit-overflow-scrolling: touch;
  }
  .pinned-wrapper::-webkit-scrollbar { height: 4px; }
  .pinned-wrapper::-webkit-scrollbar-track { background: #111; border-radius: 2px; }
  .pinned-wrapper::-webkit-scrollbar-thumb { background: #ef4444; border-radius: 2px; }
  .pinned-news {
    flex: 0 0 auto;
    width: 280px;
    min-width: 280px;
    margin-bottom: 0;
    border-radius: 8px;
  }
  .pinned-news img,
  .pinned-news video { max-height: 150px; }
  .pinned-news .content { padding: 10px; }
  .pinned-news h3 { font-size: 0.95rem; margin-bottom: 5px; }
  .pinned-news p {
    font-size: 0.8rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .nav-menu {
    width: 100%;
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: center;
    gap: 10px;
    position: static;
    background: #000;
    padding: 15px 0;
    margin-bottom: 10px;
  }
  .nav-item {
    white-space: nowrap;
    margin-bottom: 0;
    padding: 12px 20px;
    font-size: 0.9rem;
    width: auto;
    min-width: 100px;
  }
  .sidebar { display: none; }
  .container { flex-direction: column; }
  .main-news { order: 3; }
}
</style>
</head>
<body>

<div class="header">
  <div class="header-content">
    <div class="title-wrapper">
      <h1 class="title-word-1">اخبار</h1>
      <h1 class="title-word-2">صحن</h1>
      <h1 class="title-word-3">ولیعصر</h1>
    </div>
  </div>
</div>

<div class="container">
  <nav class="nav-menu">
    <div class="nav-item active" id="homeBtn"><i class="fas fa-home"></i> صفحه اصلی</div>
    <div class="nav-item" id="videoBtn"><i class="fas fa-video"></i> ویدیوها</div>
    <div class="nav-item" id="imageBtn"><i class="fas fa-images"></i> گالری تصاویر</div>
  </nav>
  
  <aside class="pinned-section">
    <div class="pinned-title">
      <i class="fas fa-thumbtack"></i> اخبار ویژه
    </div>
    <div class="pinned-wrapper" id="pinnedNews">
      <p class="loading">در حال بارگذاری...</p>
    </div>
  </aside>
  
  <main class="main-news">
    <div id="news"><p class="loading">در حال بارگذاری اخبار...</p></div>
  </main>
  
  <aside class="sidebar">
    <div class="search-box">
      <h3><i class="fas fa-search"></i> جستجو</h3>
      <input type="text" class="search-input" id="searchInput" placeholder="عنوان خبر را جستجو کنید...">
    </div>
    
    <div class="eitaa-box">
      <h3><i class="fas fa-paper-plane"></i> کانال ایتا</h3>
      <a href="https://eitaa.com/valiasrfoari" class="eitaa-link" target="_blank">
        <i class="fas fa-external-link-alt"></i>
        <span>عضویت در کانال</span>
      </a>
    </div>
  </aside>
</div>

<div id="articleModal" class="modal">
  <button class="modal-close" onclick="closeModal()">
    <i class="fas fa-times"></i>
  </button>
  <div class="modal-content">
    <div id="modalArticleContent" class="modal-article"></div>
  </div>
</div>

<script>
// ===== SIMPLE CODE WITH VIDEO SUPPORT =====

const API_BASE = 'articles/';
const newsContainer = document.getElementById("news");
const pinnedNewsContainer = document.getElementById("pinnedNews");
const searchInput = document.getElementById("searchInput");
const modal = document.getElementById("articleModal");
const modalContent = document.getElementById("modalArticleContent");
const homeBtn = document.getElementById("homeBtn");
const videoBtn = document.getElementById("videoBtn");
const imageBtn = document.getElementById("imageBtn");
const navItems = document.querySelectorAll('.nav-item');

let allArticles = [];
let currentFilter = 'all';

// Navigation
homeBtn.onclick = () => { currentFilter = 'all'; setActiveNav(homeBtn); filterArticles(); };
videoBtn.onclick = () => { currentFilter = 'video'; setActiveNav(videoBtn); filterArticles(); };
imageBtn.onclick = () => { currentFilter = 'image'; setActiveNav(imageBtn); filterArticles(); };

function setActiveNav(btn) {
  navItems.forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

// Simple fetch with timeout
async function fetchWithTimeout(url, timeout = 10000) {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeout);
  try {
    const response = await fetch(url, { signal: controller.signal });
    clearTimeout(id);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    return await response.text();
  } catch (e) {
    clearTimeout(id);
    throw e;
  }
}

// Check if file exists (for video detection)
async function fileExists(url) {
  try {
    const response = await fetch(url, { method: 'HEAD' });
    return response.ok;
  } catch {
    return false;
  }
}

// Load news
async function loadNews() {
  try {
    const response = await fetchWithTimeout(`${API_BASE}index.json?${Date.now()}`);
    const data = JSON.parse(response);
    
    let articlesList, pinnedList;
    
    if (Array.isArray(data)) {
      articlesList = data;
      pinnedList = [data[0]];
    } else if (data.pinned && data.articles) {
      pinnedList = data.pinned.map(p => typeof p === 'string' ? p : p.folder);
      articlesList = data.articles.map(a => typeof a === 'string' ? a : a.folder);
    } else {
      throw new Error('Invalid JSON format');
    }
    
    pinnedNewsContainer.innerHTML = '';
    newsContainer.innerHTML = '';
    allArticles = [];
    
    // Load pinned (max 3)
    for (let i = 0; i < Math.min(3, pinnedList.length); i++) {
      await loadPinned(pinnedList[i]);
    }
    
    // Load all articles
    for (let folder of articlesList) {
      await loadArticle(folder);
    }
    
    if (newsContainer.children.length === 0) {
      newsContainer.innerHTML = "<p class='error'>هیچ خبری یافت نشد</p>";
    }
    
  } catch (error) {
    console.error('Load error:', error);
    newsContainer.innerHTML = `<p class='error'>خطا: ${error.message}</p>`;
  }
}

// Load pinned article (with video support)
async function loadPinned(folder) {
  try {
    const text = await fetchWithTimeout(`${API_BASE}${folder}/text.txt`);
    const lines = text.split('\n');
    const title = lines[0].trim();
    const content = lines.slice(1).join('\n').trim();
    
    // Check if video exists
    const isVideo = await fileExists(`${API_BASE}${folder}/cover.mp4`);
    const mediaType = isVideo ? 'video' : 'img';
    
    const div = document.createElement('div');
    div.className = 'pinned-news';
    div.dataset.type = mediaType;
    div.onclick = () => showModal(folder, title, content, mediaType);
    
    // Create media element
    let mediaEl;
    if (isVideo) {
      mediaEl = document.createElement('video');
      mediaEl.controls = true;
      mediaEl.src = `${API_BASE}${folder}/cover.mp4`;
      // Don't preload - save bandwidth
      mediaEl.preload = 'none';
    } else {
      mediaEl = document.createElement('img');
      mediaEl.src = `${API_BASE}${folder}/cover.jpg`;
      mediaEl.loading = 'lazy';
      mediaEl.alt = title;
    }
    mediaEl.onerror = () => mediaEl.style.display = 'none';
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'content';
    contentDiv.innerHTML = `<h3>${title}</h3><p>${content.substring(0, 80)}...</p>`;
    
    div.append(mediaEl, contentDiv);
    pinnedNewsContainer.appendChild(div);
    
  } catch (e) {
    console.error(`Pinned ${folder} error:`, e);
  }
}

// Load regular article (with video support)
async function loadArticle(folder) {
  try {
    const text = await fetchWithTimeout(`${API_BASE}${folder}/text.txt`);
    const lines = text.split('\n');
    const title = lines[0].trim();
    const content = lines.slice(1).join('\n').trim();
    
    // Check if video exists
    const isVideo = await fileExists(`${API_BASE}${folder}/cover.mp4`);
    const mediaType = isVideo ? 'video' : 'img';
    
    const article = document.createElement('div');
    article.className = 'article';
    article.dataset.title = title.toLowerCase();
    article.dataset.folder = folder;
    article.dataset.content = content;
    article.dataset.type = mediaType;
    article.onclick = () => showModal(folder, title, content, mediaType);
    
    // Create media element
    let mediaEl;
    if (isVideo) {
      mediaEl = document.createElement('video');
      mediaEl.controls = true;
      mediaEl.src = `${API_BASE}${folder}/cover.mp4`;
      mediaEl.preload = 'none'; // Don't preload - save bandwidth
    } else {
      mediaEl = document.createElement('img');
      mediaEl.src = `${API_BASE}${folder}/cover.jpg`;
      mediaEl.loading = 'lazy';
      mediaEl.alt = title;
    }
    mediaEl.onerror = () => mediaEl.style.display = 'none';
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'content';
    contentDiv.innerHTML = `<h2>${title}</h2><div class="text">${content.substring(0, 150)}...</div>`;
    
    article.append(mediaEl, contentDiv);
    newsContainer.appendChild(article);
    
    allArticles.push({ element: article, title: title.toLowerCase(), folder, type: mediaType });
    
  } catch (e) {
    console.error(`Article ${folder} error:`, e);
  }
}

// Show modal (with video support)
function showModal(folder, title, content, mediaType) {
  let mediaHTML = '';
  
  if (mediaType === 'video') {
    mediaHTML = `<video controls src="${API_BASE}${folder}/cover.mp4" style="width:100%;max-height:700px;display:block;margin-bottom:30px;background:#000" autoplay></video>`;
  } else {
    mediaHTML = `<img src="${API_BASE}${folder}/cover.jpg" alt="${title}" style="width:100%;max-height:700px;display:block;margin-bottom:30px;background:#000" onerror="this.style.display='none'">`;
  }
  
  modalContent.innerHTML = `
    ${mediaHTML}
    <h1>${title}</h1>
    <div class="full-text">${content}</div>
  `;
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

// Close modal (stop videos)
function closeModal() {
  // Stop any playing video
  const video = modalContent.querySelector('video');
  if (video) {
    video.pause();
    video.currentTime = 0;
  }
  
  modal.classList.remove('active');
  document.body.style.overflow = 'auto';
}
modal.onclick = (e) => { if (e.target === modal) closeModal(); };
document.onkeydown = (e) => { if (e.key === 'Escape') closeModal(); };

// Search
searchInput.oninput = () => {
  const term = searchInput.value.toLowerCase().trim();
  let visible = 0;
  
  document.querySelectorAll('.article').forEach(el => {
    const title = el.dataset.title || '';
    if (!term || title.includes(term)) {
      el.classList.remove('hidden');
      visible++;
    } else {
      el.classList.add('hidden');
    }
  });
  
  document.querySelector('.no-results')?.remove();
  if (!visible && term) {
    const msg = document.createElement('p');
    msg.className = 'no-results';
    msg.textContent = 'هیچ خبری با این عنوان یافت نشد';
    newsContainer.appendChild(msg);
  }
};

// Filter articles by type (video/image)
function filterArticles() {
  let visible = 0;
  
  document.querySelectorAll('.article').forEach(el => {
    const type = el.dataset.type || 'img';
    
    if (currentFilter === 'all') {
      el.classList.remove('hidden');
      visible++;
    } else if (currentFilter === 'video' && type === 'video') {
      el.classList.remove('hidden');
      visible++;
    } else if (currentFilter === 'image' && type === 'img') {
      el.classList.remove('hidden');
      visible++;
    } else {
      el.classList.add('hidden');
    }
  });
  
  // Show/hide no results
  document.querySelector('.no-results')?.remove();
  if (visible === 0 && currentFilter !== 'all') {
    const msg = document.createElement('p');
    msg.className = 'no-results';
    msg.textContent = currentFilter === 'video' ? 'هیچ ویدیویی یافت نشد' : 'هیچ تصویری یافت نشد';
    newsContainer.appendChild(msg);
  }
}

// Start loading
loadNews();
</script>

</body>
</html>
