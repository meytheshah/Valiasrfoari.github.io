<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>اخبار صحن ولیعصر</title>
<link rel="icon" type="image/png" href="logo.png">
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
* { box-sizing: border-box; }

body {
  background: #000000;
  color: #e5e7eb;
  font-family: 'Vazirmatn', sans-serif;
  margin: 0;
  padding: 0;
}

.header {
  background: #111111;
  padding: 15px 20px;
  border-bottom: 3px solid #ef4444;
  position: sticky;
  top: 0;
  z-index: 100;
}

.header-content {
  max-width: 1400px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
}

.title-wrapper { 
  display: flex; 
  gap: 15px;
  justify-content: center;
  align-items: center;
}

.title-word-1 { color: #239f40; font-size: 2.5rem; font-weight: 900; margin: 0; }
.title-word-2 { color: #ffffff; font-size: 2.5rem; font-weight: 900; margin: 0; }
.title-word-3 { color: #da0000; font-size: 2.5rem; font-weight: 900; margin: 0; }

.container {
  display: flex;
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
  gap: 20px;
}

/* Navigation Menu - Centered */
.nav-menu {
  width: 200px;
  flex-shrink: 0;
  position: sticky;
  top: 120px;
  height: fit-content;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.nav-item {
  background: #111111;
  padding: 15px 20px;
  margin-bottom: 10px;
  border: 2px solid #222;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  width: 100%;
  text-align: center;
}

.nav-item:hover { background: #1a1a1a; border-color: #ef4444; }
.nav-item i { color: #ef4444; }

/* Pinned News Section */
.pinned-section {
  width: 350px;
  flex-shrink: 0;
  position: sticky;
  top: 120px;
  height: fit-content;
  max-height: calc(100vh - 140px);
  overflow-y: auto;
}

.pinned-title {
  background: #111111;
  padding: 15px;
  border: 2px solid #ef4444;
  margin-bottom: 15px;
  text-align: center;
  font-size: 1.3rem;
  font-weight: bold;
  color: #ef4444;
}

.pinned-news {
  background: #111111;
  border: 2px solid #333;
  overflow: hidden;
  margin-bottom: 15px;
  cursor: pointer;
  transition: all 0.3s;
}

.pinned-news:hover { border-color: #ef4444; }

.pinned-news video,
.pinned-news img {
  width: 100%;
  height: auto;
  max-height: 300px;
  object-fit: contain;
  display: block;
  background: #000;
}

.pinned-news .content { padding: 15px; }
.pinned-news h3 { margin: 0 0 10px 0; color: #ffffff; font-size: 1.1rem; }
.pinned-news p { margin: 0; color: #cbd5e1; line-height: 1.6; font-size: 0.9rem; }

.main-news { flex: 1; display: flex; flex-direction: column; gap: 20px; }

.article {
  background: #111111;
  border: 2px solid #222;
  cursor: pointer;
  transition: all 0.3s;
  overflow: hidden;
}

.article:hover { border-color: #ef4444; transform: translateY(-2px); }
.article.hidden { display: none; }

.article img,
.article video {
  width: 100%;
  height: auto;
  max-height: 600px;
  object-fit: contain;
  display: block;
  background: #000;
}

.article .content { padding: 20px; }
.article h2 { margin: 0 0 15px 0; color: #ffffff; font-size: 1.5rem; }
.article .text { color: #cbd5e1; line-height: 1.8; font-size: 1rem; }

.sidebar {
  width: 250px;
  flex-shrink: 0;
  position: sticky;
  top: 120px;
  height: fit-content;
}

.search-box {
  background: #111111;
  padding: 15px;
  margin-bottom: 15px;
  border: 2px solid #222;
}

.search-box h3 { margin: 0 0 15px 0; color: #ffffff; font-size: 1.1rem; text-align: center; }

.search-input {
  width: 100%;
  padding: 10px;
  border: 2px solid #333;
  background: #000;
  color: #e5e7eb;
  font-family: 'Vazirmatn', sans-serif;
  font-size: 0.95rem;
}

.search-input:focus { outline: none; border-color: #ffffff; }

.eitaa-box {
  background: #111111;
  padding: 15px;
  border: 2px solid #222;
  text-align: center;
}

.eitaa-box h3 { margin: 0 0 15px 0; color: #ffffff; font-size: 1.1rem; }

.eitaa-link {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  width: 100%;
  padding: 12px;
  background: #ef4444;
  color: #000;
  text-decoration: none;
  font-weight: bold;
  font-size: 1rem;
  transition: all 0.3s;
}

.eitaa-link:hover { background: #dc2626; }
.eitaa-link i { font-size: 1.3rem; }

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.98);
  z-index: 1000;
  overflow-y: auto;
}

.modal.active { display: block; }

.modal-content {
  max-width: 1000px;
  margin: 0 auto;
  padding: 60px 20px 40px;
}

.modal-close {
  position: fixed;
  top: 20px;
  left: 20px;
  background: #ef4444;
  color: #000;
  border: none;
  width: 50px;
  height: 50px;
  font-size: 1.5rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
  z-index: 1001;
}

.modal-close:hover { background: #dc2626; transform: rotate(90deg); }

.modal-article {
  background: #111111;
  border: 3px solid #ef4444;
  padding: 30px;
}

.modal-article img,
.modal-article video {
  width: 100%;
  height: auto;
  max-height: 700px;
  object-fit: contain;
  display: block;
  margin-bottom: 30px;
  background: #000;
}

.modal-article h1 {
  color: #ffffff;
  font-size: 2.5rem;
  margin: 0 0 30px 0;
  border-bottom: 2px solid #ef4444;
  padding-bottom: 20px;
}

.modal-article .full-text {
  color: #cbd5e1;
  line-height: 2;
  font-size: 1.2rem;
  white-space: pre-wrap;
}

.error { color: #ef4444; text-align: center; font-size: 1.2rem; padding: 40px; }
.loading { text-align: center; color: #ffffff; font-size: 1.2rem; padding: 40px; }
.no-results { text-align: center; color: #888; padding: 40px; font-size: 1.2rem; }

/* Desktop - Show Pinned Section */
@media (min-width: 769px) {
  .pinned-section {
    display: block;
  }
}

/* Mobile */
@media (max-width: 768px) {
  .title-word-1,
  .title-word-2,
  .title-word-3 {
    font-size: 1.8rem;
  }
  
  .modal-article h1 { font-size: 1.8rem; }
  .modal-article .full-text { font-size: 1rem; }
  
  /* Pinned Section on Mobile */
  .pinned-section {
    display: block;
    width: 100%;
    position: static;
    max-height: none;
    margin-bottom: 20px;
  }
  
  .pinned-wrapper {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    scroll-behavior: smooth;
    padding: 5px;
    -webkit-overflow-scrolling: touch;
  }
  
  .pinned-wrapper::-webkit-scrollbar {
    height: 4px;
  }
  
  .pinned-wrapper::-webkit-scrollbar-track {
    background: #111;
    border-radius: 2px;
  }
  
  .pinned-wrapper::-webkit-scrollbar-thumb {
    background: #ef4444;
    border-radius: 2px;
  }
  
  .pinned-news {
    flex: 0 0 auto;
    width: 280px;
    min-width: 280px;
    margin-bottom: 0;
    border-radius: 8px;
  }
  
  .pinned-news video,
  .pinned-news img {
    max-height: 150px;
  }
  
  .pinned-news .content {
    padding: 10px;
  }
  
  .pinned-news h3 {
    font-size: 0.95rem;
    margin-bottom: 5px;
  }
  
  .pinned-news p {
    font-size: 0.8rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  /* Navigation Menu - Centered on Mobile */
  .nav-menu {
    width: 100%;
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: center;
    gap: 10px;
    position: static;
    background: #000;
    padding: 15px 0;
    margin-bottom: 10px;
  }
  
  .nav-item {
    white-space: nowrap;
    margin-bottom: 0;
    padding: 12px 20px;
    font-size: 0.9rem;
    width: auto;
    min-width: 100px;
  }
  
  .sidebar {
    width: 100%;
    position: static;
    order: 4;
  }
  
  .container {
    flex-direction: column;
  }
  
  .main-news {
    order: 3;
  }
  
  /* Mobile Search at Bottom */
  .mobile-search-container {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #111111;
    padding: 15px;
    border-top: 3px solid #ef4444;
    z-index: 95;
  }
  
  .mobile-search-container input {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #333;
    background: #000;
    color: #e5e7eb;
    font-family: 'Vazirmatn', sans-serif;
    font-size: 1rem;
    border-radius: 8px;
  }
  
  .mobile-search-container input:focus {
    outline: none;
    border-color: #ef4444;
  }
  
  body {
    padding-bottom: 80px;
  }
}
</style>
</head>
<body>

<div class="header">
  <div class="header-content">
    <div class="title-wrapper">
      <h1 class="title-word-1">اخبار</h1>
      <h1 class="title-word-2">صحن</h1>
      <h1 class="title-word-3">ولیعصر</h1>
    </div>
  </div>
</div>

<div class="container">
  <nav class="nav-menu">
    <div class="nav-item" id="homeBtn"><i class="fas fa-home"></i> صفحه اصلی</div>
    <div class="nav-item" id="videoBtn"><i class="fas fa-video"></i> ویدیوها</div>
    <div class="nav-item" id="imageBtn"><i class="fas fa-images"></i> گالری تصاویر</div>
  </nav>
  
  <!-- Pinned Section -->
  <aside class="pinned-section">
    <div class="pinned-title">
      <i class="fas fa-thumbtack"></i> اخبار ویژه
    </div>
    <div class="pinned-wrapper" id="pinnedNews">
      <p class="loading">در حال بارگذاری...</p>
    </div>
  </aside>
  
  <main class="main-news">
    <div id="news"><p class="loading">در حال بارگذاری اخبار...</p></div>
  </main>
  
  <aside class="sidebar">
    <div class="search-box">
      <h3><i class="fas fa-search"></i> جستجو</h3>
      <input type="text" class="search-input" id="searchInput" placeholder="عنوان خبر را جستجو کنید...">
    </div>
    
    <div class="eitaa-box">
      <h3><i class="fas fa-paper-plane"></i> کانال ایتا</h3>
      <a href="https://eitaa.com/valiasrfoari" class="eitaa-link" target="_blank">
        <i class="fas fa-external-link-alt"></i>
        <span>عضویت در کانال</span>
      </a>
    </div>
  </aside>
</div>

<!-- Mobile Search at Bottom -->
<div class="mobile-search-container" id="mobileSearchContainer" style="display: none;">
  <input type="text" id="mobileSearchInput" placeholder="عنوان خبر را جستجو کنید...">
</div>

<div id="articleModal" class="modal">
  <button class="modal-close" onclick="closeModal()">
    <i class="fas fa-times"></i>
  </button>
  <div class="modal-content">
    <div id="modalArticleContent" class="modal-article"></div>
  </div>
</div>

<script>
const newsContainer = document.getElementById("news");
const pinnedNewsContainer = document.getElementById("pinnedNews");
const searchInput = document.getElementById("searchInput");
const mobileSearchInput = document.getElementById("mobileSearchInput");
const mobileSearchContainer = document.getElementById("mobileSearchContainer");
const modal = document.getElementById("articleModal");
const modalContent = document.getElementById("modalArticleContent");
const homeBtn = document.getElementById("homeBtn");
const videoBtn = document.getElementById("videoBtn");
const imageBtn = document.getElementById("imageBtn");

let allArticles = [];
let fullArticlesData = [];
let isMobile = window.innerWidth <= 768;

function checkMobile() {
  isMobile = window.innerWidth <= 768;
  if (isMobile) {
    mobileSearchContainer.style.display = 'block';
  } else {
    mobileSearchContainer.style.display = 'none';
  }
}

window.addEventListener('resize', checkMobile);
checkMobile();

homeBtn.addEventListener('click', () => {
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

videoBtn.addEventListener('click', () => {
  window.scrollTo({ top: 0, behavior: 'smooth' });
  filterByType('video');
});

imageBtn.addEventListener('click', () => {
  window.scrollTo({ top: 0, behavior: 'smooth' });
  filterByType('image');
});

async function fetchText(url) {
  const response = await fetch(url);
  if (!response.ok) throw new Error(`خطا در بارگذاری ${url}`);
  return await response.text();
}

async function loadNews() {
  try {
    const timestamp = new Date().getTime();
    const response = await fetch(`articles/index.json?t=${timestamp}`, {
      cache: 'no-store',
      headers: { 'Cache-Control': 'no-cache' }
    });
    
    if (!response.ok) throw new Error(`خطا: ${response.status}`);
    
    const data = await response.json();
    let articlesList, pinnedList;
    
    if (Array.isArray(data)) {
      articlesList = data;
      pinnedList = data.slice(0, 1);
    } else if (data.pinned && data.articles) {
      pinnedList = data.pinned;
      articlesList = data.articles;
    } else {
      throw new Error('فرمت JSON نامعتبر');
    }
    
    newsContainer.innerHTML = "";
    pinnedNewsContainer.innerHTML = "";
    allArticles = [];
    fullArticlesData = [];

    for (let folder of pinnedList) {
      await loadPinnedNews(folder);
    }

    for (let folder of articlesList) {
      await loadArticle(folder);
    }

    if (newsContainer.children.length === 0) {
      newsContainer.innerHTML = "<p class='error'>هیچ خبری یافت نشد.</p>";
    }

    if (pinnedNewsContainer.children.length === 0) {
      pinnedNewsContainer.innerHTML = "<p class='error'>خبر ویژه‌ای وجود ندارد</p>";
    }

  } catch (error) {
    console.error(error);
    newsContainer.innerHTML = `<p class='error'>خطا: ${error.message}</p>`;
  }
}

async function loadPinnedNews(folder) {
  try {
    const fullText = await fetchText(`articles/${folder}/text.txt`);
    const lines = fullText.split('\n');
    const titleText = lines[0].trim();
    const contentText = lines.slice(1).join('\n').trim();
    
    const pinnedContainer = document.createElement('div');
    pinnedContainer.className = 'pinned-news';
    pinnedContainer.onclick = () => openModal(folder, titleText, contentText);
    
    let mediaElement, mediaType = 'img';
    try {
      const videoResponse = await fetch(`articles/${folder}/cover.mp4?t=${new Date().getTime()}`);
      if (videoResponse.ok) {
        mediaElement = document.createElement('video');
        mediaElement.controls = true;
        mediaElement.src = `articles/${folder}/cover.mp4`;
        mediaType = 'video';
      } else {
        mediaElement = document.createElement('img');
        mediaElement.src = `articles/${folder}/cover.jpg?t=${new Date().getTime()}`;
      }
    } catch (e) {
      mediaElement = document.createElement('img');
      mediaElement.src = `articles/${folder}/cover.jpg?t=${new Date().getTime()}`;
    }
    mediaElement.onerror = () => { mediaElement.style.display = 'none'; };
    
    const content = document.createElement('div');
    content.className = 'content';
    
    const title = document.createElement('h3');
    title.textContent = titleText;
    
    const text = document.createElement('p');
    text.textContent = contentText.substring(0, 80) + '...';
    
    content.append(title, text);
    pinnedContainer.append(mediaElement, content);
    pinnedNewsContainer.appendChild(pinnedContainer);
    
    fullArticlesData.push({ folder, title: titleText.toLowerCase(), content: contentText, type: mediaType });
  } catch (err) {
    console.error(`خطا در خبر ویژه ${folder}:`, err);
  }
}

async function loadArticle(folder) {
  try {
    const fullText = await fetchText(`articles/${folder}/text.txt`);
    const lines = fullText.split('\n');
    const titleText = lines[0].trim();
    const contentText = lines.slice(1).join('\n').trim();
    
    const container = document.createElement("div");
    container.className = "article";
    container.dataset.title = titleText.toLowerCase();
    container.onclick = () => openModal(folder, titleText, contentText);
    
    let mediaElement, mediaType = 'img';
    try {
      const videoResponse = await fetch(`articles/${folder}/cover.mp4?t=${new Date().getTime()}`);
      if (videoResponse.ok) {
        mediaElement = document.createElement('video');
        mediaElement.controls = true;
        mediaElement.src = `articles/${folder}/cover.mp4`;
        mediaType = 'video';
      } else {
        mediaElement = document.createElement('img');
        mediaElement.src = `articles/${folder}/cover.jpg?t=${new Date().getTime()}`;
      }
    } catch (e) {
      mediaElement = document.createElement('img');
      mediaElement.src = `articles/${folder}/cover.jpg?t=${new Date().getTime()}`;
    }
    mediaElement.onerror = () => { mediaElement.style.display = 'none'; };
    
    const contentDiv = document.createElement("div");
    contentDiv.className = "content";
    
    const title = document.createElement("h2");
    title.textContent = titleText;
    
    const text = document.createElement("div");
    text.className = "text";
    text.textContent = contentText.substring(0, 150) + '...';
    
    contentDiv.append(title, text);
    container.append(mediaElement, contentDiv);
    newsContainer.appendChild(container);
    
    allArticles.push({ element: container, title: titleText.toLowerCase(), folder, type: mediaType });
    fullArticlesData.push({ folder, title: titleText.toLowerCase(), content: contentText, type: mediaType });
  } catch (err) {
    console.error(`خطا در مقاله ${folder}:`, err);
  }
}

function filterByType(type) {
  let visibleCount = 0;
  
  allArticles.forEach(article => {
    if (type === 'video' && article.type === 'video') {
      article.element.classList.remove('hidden');
      visibleCount++;
    } else if (type === 'image' && article.type === 'img') {
      article.element.classList.remove('hidden');
      visibleCount++;
    } else if (type === 'all') {
      article.element.classList.remove('hidden');
      visibleCount++;
    } else {
      article.element.classList.add('hidden');
    }
  });
  
  const existingNoResults = document.querySelector('.no-results');
  if (existingNoResults) existingNoResults.remove();
  
  if (visibleCount === 0 && type !== 'all') {
    const noResults = document.createElement('p');
    noResults.className = 'no-results';
    noResults.textContent = type === 'video' ? 'هیچ ویدیویی یافت نشد.' : 'هیچ تصویری یافت نشد.';
    newsContainer.appendChild(noResults);
  }
}

function openModal(folder, title, content) {
  let mediaHTML = `<img src="articles/${folder}/cover.jpg?t=${new Date().getTime()}" alt="${title}" onerror="this.style.display='none'" style="width:100%;max-height:700px;display:block;margin-bottom:30px;background:#000">`;
  
  fetch(`articles/${folder}/cover.mp4?t=${new Date().getTime()}`)
    .then(response => {
      if (response.ok) {
        mediaHTML = `<video controls src="articles/${folder}/cover.mp4" style="width:100%;max-height:700px;display:block;margin-bottom:30px;background:#000"></video>`;
      }
      modalContent.innerHTML = `${mediaHTML}<h1>${title}</h1><div class="full-text">${content}</div>`;
    })
    .catch(() => {
      modalContent.innerHTML = `${mediaHTML}<h1>${title}</h1><div class="full-text">${content}</div>`;
    });
  
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  modal.classList.remove('active');
  document.body.style.overflow = 'auto';
}

modal.addEventListener('click', (e) => {
  if (e.target === modal) closeModal();
});

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && modal.classList.contains('active')) closeModal();
});

function performSearch() {
  const searchTerm = (searchInput.value || mobileSearchInput.value).toLowerCase().trim();
  searchInput.value = searchTerm;
  mobileSearchInput.value = searchTerm;
  
  let visibleCount = 0;
  
  allArticles.forEach(article => {
    if (searchTerm === '' || article.title.includes(searchTerm)) {
      article.element.classList.remove('hidden');
      visibleCount++;
    } else {
      article.element.classList.add('hidden');
    }
  });
  
  const existingNoResults = document.querySelector('.no-results');
  if (existingNoResults) existingNoResults.remove();
  
  if (visibleCount === 0 && searchTerm !== '') {
    const noResults = document.createElement('p');
    noResults.className = 'no-results';
    noResults.textContent = 'هیچ خبری با این عنوان یافت نشد.';
    newsContainer.appendChild(noResults);
  }
}

searchInput.addEventListener('input', performSearch);
mobileSearchInput.addEventListener('input', performSearch);

loadNews();
</script>

</body>
</html>
